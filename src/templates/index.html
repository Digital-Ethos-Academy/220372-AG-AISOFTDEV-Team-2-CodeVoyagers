{% extends "base.html" %}

{% block title %}AI Utils - Demo{% endblock %}

{% block content %}
<h1>Performance Evaluation Dashboard</h1>
<p>Project managers review employee metrics, skills, and readiness for strategic tasks.</p>

<div id="actionStatusBar" class="status-bar"></div>

<div class="dashboard-container">
  <div class="fixed-columns">
  <!-- Column 1: Project Managers -->
    <div class="column">
      <h3>Project Managers</h3>
      <div class="user-list" id="managerList"></div>
      <div class="add-button" onclick="openAddManagerModal()">
        <span class="plus-icon">+</span>Add New Project Manager
      </div>
    </div>

  <!-- Column 2: Employees -->
    <div class="column">
      <h3>Employees</h3>
      <div class="user-list" id="employeeList"></div>
      <div class="add-button" onclick="openAddEmployeeModal()">
        <span class="plus-icon">+</span>Add New Employee
      </div>
    </div>
  </div>

  <div class="flexible-columns">
    <!-- Column 3: Information Card -->
    <div class="column" id="profileColumn">
  <h3>Employee Profile</h3>
      <div id="profileCard" class="profile-card">
  <p>Select an employee to view their detailed profile and metrics.</p>
      </div>
    </div>

    <!-- Splitter -->
    <div class="splitter" id="splitter"></div>

    <!-- Column 4: Conversation Output -->
    <div class="column" id="conversationColumn">
  <h3>Potential Discussion</h3>
      <div id="conversationOutput" class="conversation-output">
  <p>Select both a project manager and an employee to explore growth and role potential.</p>
      </div>
    </div>
  </div>
</div>

<!-- Add Project Manager Modal -->
<div id="addManagerModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
  <h3>Add New Project Manager</h3>
  <button class="close" onclick="closeModal('addManagerModal')">&times;</button>
    </div>
  <form id="managerForm">
      <div class="form-group">
  <label for="managerName">Full Name:</label>
  <input type="text" id="managerName" name="name" required>
      </div>
      <div class="form-group">
  <label for="managerRole">Role:</label>
  <input type="text" id="managerRole" name="role" required>
      </div>
      <div class="form-group">
  <label for="managerDepartment">Department:</label>
  <input type="text" id="managerDepartment" name="department" required>
      </div>
      <div class="form-group">
  <label for="managerEmail">Email:</label>
  <input type="email" id="managerEmail" name="email" required>
      </div>
      <div class="form-group">
  <label for="managerExperience">Years of Experience:</label>
  <input type="number" id="managerExperience" name="experience" min="0" max="50" required>
      </div>
      <div class="form-group">
        <label for="managerFocus">Primary Focus Area:</label>
        <input type="text" id="managerFocus" name="focus_area" placeholder="e.g. Scalability, Delivery, Quality" required>
      </div>
      <div class="form-group">
        <label for="managerActiveProject">Active Project Name:</label>
        <input type="text" id="managerActiveProject" name="active_project" placeholder="e.g. Event Stream Platform" required>
      </div>
      <div class="form-group">
        <label for="managerProjectSummary">Project Summary:</label>
        <textarea id="managerProjectSummary" name="project_summary" placeholder="Brief one sentence description" required></textarea>
      </div>
      <div class="form-group">
        <label for="managerRequiredSkills">Required Skills (comma-separated):</label>
        <textarea id="managerRequiredSkills" name="required_skills" placeholder="React, Node.js, Kafka, Python" required></textarea>
      </div>
      <div class="form-actions">
    <button type="button" class="btn-generate" onclick="openPromptModal('project-manager')">Generate Data</button>
    <button type="button" class="btn-secondary" onclick="closeModal('addManagerModal')">Cancel</button>
    <button type="submit" class="btn-primary">Add Project Manager</button>
      </div>
    </form>
  </div>
</div>

<!-- Add Employee Modal -->
<div id="addEmployeeModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
  <h3>Add New Employee</h3>
  <button class="close" onclick="closeModal('addEmployeeModal')">&times;</button>
    </div>
  <form id="employeeForm">
      <div class="form-group">
  <label for="employeeName">Full Name:</label>
  <input type="text" id="employeeName" name="name" required>
      </div>
      <div class="form-group">
  <label for="employeeTitle">Job Title/Role:</label>
  <input type="text" id="employeeTitle" name="title" required>
      </div>
      <div class="form-group">
  <label for="employeeExperience">Years of Experience:</label>
  <input type="number" id="employeeExperience" name="experience" min="0" max="50" required>
      </div>
      <div class="form-group">
  <label for="employeeEducation">Education:</label>
  <input type="text" id="employeeEducation" name="education" required>
      </div>
      <div class="form-group">
  <label for="employeeLocation">Location:</label>
  <input type="text" id="employeeLocation" name="location" required>
      </div>
      <div class="form-group">
  <label for="employeeSkills">Skills (comma-separated):</label>
  <textarea id="employeeSkills" name="skills" placeholder="React, Node.js, Python..." required></textarea>
      </div>
      <div class="form-group">
        <label for="employeeMetrics">Performance Metrics (comma-separated 'Key: value' pairs):</label>
        <textarea id="employeeMetrics" name="metrics" placeholder="Projects Delivered: 12, Quality Score: 91, Velocity: 24, Skill Alignment Score: 78"></textarea>
      </div>
      <div class="form-group">
  <label for="employeeSummary">Performance Summary:</label>
  <textarea id="employeeSummary" name="summary" required></textarea>
      </div>
      <div class="form-actions">
    <button type="button" class="btn-generate" onclick="openPromptModal('employee')">Generate Data</button>
    <button type="button" class="btn-secondary" onclick="closeModal('addEmployeeModal')">Cancel</button>
    <button type="submit" class="btn-primary">Add Employee</button>
      </div>
    </form>
  </div>
</div>
<!-- Prompt Modal -->
<div id="promptModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="promptModalTitle">Generate Data</h3>
      <button class="close" onclick="closeModal('promptModal')">&times;</button>
    </div>
    <form id="promptForm">
      <div class="form-group">
        <label for="generationPrompt">Optional Prompt (leave blank for generic):</label>
  <textarea id="generationPrompt" name="prompt" placeholder="e.g. Senior project manager focused on platform scalability OR Mid-level engineer specializing in distributed systems..."></textarea>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn-primary">Generate</button>
        <button type="button" class="btn-secondary" onclick="closeModal('promptModal')">Cancel</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Loading / notification utilities
  function setLoading(btn, isLoading, loadingText='Processing...') {
    if (!btn) return;
    if (isLoading) {
      btn.dataset.originalText = btn.textContent;
      btn.classList.add('loading');
      btn.innerHTML = `<span class="spinner"></span>${loadingText}`;
      btn.disabled = true;
      showStatus(loadingText);
    } else {
      btn.classList.remove('loading');
      btn.innerHTML = btn.dataset.originalText || 'Submit';
      btn.disabled = false;
      clearStatus();
    }
  }

  function showStatus(message) {
    const bar = document.getElementById('actionStatusBar');
    if (!bar) return;
    bar.textContent = message;
    bar.classList.add('visible');
  }
  function clearStatus() {
    const bar = document.getElementById('actionStatusBar');
    if (!bar) return;
    bar.textContent = '';
    bar.classList.remove('visible');
  }

  // State
  let selectedManager = null;
  let selectedEmployee = null;
  const managerData = {};
  const employeeData = {};
  let generationTarget = null; // 'project-manager' or 'employee'
  let discussionHistory = [];

  // Initial load
  loadInitialData();

  async function loadInitialData() {
    await Promise.all([loadManagers(), loadEmployees()]);
  }

  async function loadManagers() {
    const list = document.getElementById('managerList');
    list.innerHTML = '<p>Loading project managers...</p>';
    try {
      const res = await fetch('/api/project-managers');
      const data = await res.json();
      list.innerHTML = '';
      (data.project_managers || []).forEach(pm => {
        managerData[pm.id] = pm;
        const el = document.createElement('div');
        el.className = 'user-item';
        el.onclick = () => selectManager(pm.id, el);
        el.innerHTML = `<h4>${pm.name}</h4><p>${pm.role}</p><span class="company">${pm.department}</span>`;
        list.appendChild(el);
      });
    } catch (e) {
      list.innerHTML = '<p>Error loading project managers.</p>';
    }
  }

  async function loadEmployees() {
    const list = document.getElementById('employeeList');
    list.innerHTML = '<p>Loading employees...</p>';
    try {
      const res = await fetch('/api/employees');
      const data = await res.json();
      list.innerHTML = '';
      (data.employees || []).forEach(emp => {
        employeeData[emp.id] = emp;
        const el = document.createElement('div');
        el.className = 'user-item';
        el.onclick = () => selectEmployee(emp.id, el);
        el.innerHTML = `<h4>${emp.name}</h4><p>${emp.title}</p><span class="experience">${emp.experience_years} yrs</span><div class="skills">${(emp.skills||[]).slice(0,3).join(', ')}</div>`;
        list.appendChild(el);
      });
    } catch (e) {
      list.innerHTML = '<p>Error loading employees.</p>';
    }
  }

  // Selection handlers
  function selectManager(id, el) {
    document.querySelectorAll('#managerList .user-item').forEach(n => n.classList.remove('selected'));
    el.classList.add('selected');
    selectedManager = id;
    // Refresh employee profile if one is already selected so required skills table appears
    if (selectedEmployee) {
      updateEmployeeProfile(selectedEmployee);
    }
    updateDiscussion();
  }

  function selectEmployee(id, el) {
    document.querySelectorAll('#employeeList .user-item').forEach(n => n.classList.remove('selected'));
    el.classList.add('selected');
    selectedEmployee = id;
    updateEmployeeProfile(id);
    updateDiscussion();
  }

  function updateEmployeeProfile(employeeId) {
    const profileCard = document.getElementById('profileCard');
    const emp = employeeData[employeeId];
    if (!emp) return;
    const metricExplanations = {
      'Projects Delivered': 'Total distinct deliverables shipped in last 18 months.',
      'Quality Score': 'Normalized code quality/review metric (0-100).',
      'Velocity': 'Average sprint story points completed.'
    };
    // Build required skills vs overlap table if a project manager is selected
    let projectSection = '';
    if (selectedManager && managerData[selectedManager]) {
      const pm = managerData[selectedManager];
      const required = (pm.required_skills || []).map(s=>s.trim()).filter(Boolean);
      if (required.length) {
        const empSkillsSet = new Set((emp.skills||[]).map(s=>s.toLowerCase()));
        let matched = 0;
        const rows = required.map(skill => {
          const has = empSkillsSet.has(skill.toLowerCase());
          if (has) matched += 1;
          return `<tr><td>${skill}</td><td class="${has ? 'match-yes' : 'match-no'}">${has ? '✓ Match' : '✕ Gap'}</td></tr>`;
        }).join('');
        const alignmentPct = Math.round((matched / required.length) * 100);
        projectSection = `
          <div class="profile-section">
            <h5>Project Requirements</h5>
            <p><strong>Project:</strong> ${pm.active_project || '(none)'}<br><strong>Alignment:</strong> ${alignmentPct}% (${matched}/${required.length} matches)</p>
            <table class="skills-table">
              <thead><tr><th>Required Skill</th><th>Status</th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
          </div>`;
      }
    }
    profileCard.innerHTML = `
      <div class="profile-header">
        <h4>${emp.name}</h4>
        <p class="title">${emp.title}</p>
        <p class="location">${emp.location}</p>
      </div>
      <div class="profile-section">
        <h5>Experience & Education</h5>
        <p><strong>Experience:</strong> ${emp.experience_years} years</p>
        <p><strong>Education:</strong> ${emp.education}</p>
      </div>
      <div class="profile-section">
        <h5>Key Skills</h5>
        <div class="skills-tags">${(emp.skills||[]).map(s=>`<span class="skill-tag">${s}</span>`).join('')}</div>
      </div>
      ${projectSection}
      <div class="profile-section">
        <h5>Performance Metrics</h5>
        <div class="metrics">
          ${Object.entries(emp.metrics||{}).map(([k,v])=>{
            const tip = metricExplanations[k] || 'Metric definition unavailable.';
            return `<div class="metric-item"><span class="metric-label">${k}:</span><span class="metric-value" title="${tip}">${v}</span></div>`;
          }).join('')}
        </div>
      </div>
      <div class="profile-section">
        <h5>Summary</h5>
        <p>${emp.summary || 'No summary provided.'}</p>
      </div>
    `;
  }

  // Discussion (conversation) handling
  function updateDiscussion() {
    const container = document.getElementById('conversationOutput');
    if (!selectedManager || !selectedEmployee) {
      container.innerHTML = '<p>Select both a project manager and an employee to generate discussion insights.</p>';
      discussionHistory = [];
      return;
    }
    const refreshBtn = document.querySelector('button.btn-primary[onclick="refreshDiscussion()"]');
    setLoading(refreshBtn, true, 'Loading discussion...');
    fetch(`/api/conversation?manager_id=${selectedManager}&employee_id=${selectedEmployee}`)
      .then(r=>r.json())
      .then(data => { discussionHistory = data.conversation || []; renderDiscussion(); })
      .catch(()=>{ discussionHistory=[]; renderDiscussion(); })
      .finally(()=> setLoading(refreshBtn, false));
  }

  function renderDiscussion() {
    const emp = employeeData[selectedEmployee];
    const pmName = managerData[selectedManager]?.name || 'Manager';
    let html = `<div class="conversation"><div class="conversation-header"><h5>Discussion about ${emp?.name||'Employee'}</h5><p>Project Manager: ${pmName}</p></div><div class="conversation-messages">`;
    html += discussionHistory.map(msg => {
  let cls = 'message manager';
      if (msg.role === 'hr') cls = 'message hr';
      if (msg.role === 'teamlead') cls = 'message teamlead';
      if (msg.role === 'manager') cls = 'message manager';
      return `<div class="${cls}"><strong>${msg.speaker}:</strong> ${msg.text}</div>`;
    }).join('');
    html += `</div><div class="conversation-actions">`;
    html += `<button onclick="refreshDiscussion()" class="btn-primary">Refresh Discussion</button>`;
    html += `<button onclick="newDiscussion()" class="btn-primary" style="background:#e74c3c">New Discussion</button>`;
    html += `<button onclick="continueDiscussion()" class="btn-primary" style="background:#8e44ad">Continue Discussion</button>`;
    html += `<button onclick="toggleInjectComment()" class="btn-primary" style="background:#16a085">Inject Team Lead Comment</button>`;
    html += `</div>`;
    html += `<div id="injectCommentArea" style="display:none; margin-top:1rem;" class="card">`;
    html += `<h5>Team Lead Comment</h5>`;
    html += `<textarea id="teamLeadInput" style="width:100%; min-height:80px;" placeholder="Enter your question or comment about this employee..."></textarea>`;
    html += `<div style="text-align:right; margin-top:0.5rem;">`;
    html += `<button class="btn-primary" onclick="submitTeamLeadComment()" style="background:#16a085">Add Comment</button>`;
    html += `<button class="btn-secondary" onclick="toggleInjectComment()">Cancel</button>`;
    html += `</div></div>`;
    html += `</div>`;
    document.getElementById('conversationOutput').innerHTML = html;
  }

  function refreshDiscussion(){ updateDiscussion(); }

  function newDiscussion() {
    if (!selectedManager || !selectedEmployee) return;
    const btn = document.querySelector('button.btn-primary[onclick="newDiscussion()"]');
    setLoading(btn, true, 'Starting new discussion...');
    fetch('/api/conversation/new', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({manager_id: selectedManager, employee_id: selectedEmployee})})
      .then(r=>r.json())
      .then(data => { discussionHistory = data.conversation || []; renderDiscussion(); })
      .finally(()=> setLoading(btn, false));
  }

  function continueDiscussion() {
    if (!selectedManager || !selectedEmployee) return;
    const btn = document.querySelector('button.btn-primary[onclick="continueDiscussion()"]');
    // Check if last message is a team lead comment needing answer
    const pending = discussionHistory.length && discussionHistory[discussionHistory.length-1].role === 'teamlead';
    setLoading(btn, true, pending ? 'Analyzing team lead comment and generating response...' : 'Extending discussion...');
    fetch('/api/conversation/continue', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({manager_id: selectedManager, employee_id: selectedEmployee})})
      .then(r=>r.json())
      .then(data => { discussionHistory = data.conversation || discussionHistory; renderDiscussion(); })
      .finally(()=> setLoading(btn, false));
  }

  function toggleInjectComment() {
    console.log('toggleInjectComment called');
    const area = document.getElementById('injectCommentArea');
    if (!area) {
      console.log('injectCommentArea not found');
      return;
    }
    const isHidden = area.style.display === 'none' || area.style.display === '';
    area.style.display = isHidden ? 'block' : 'none';
    console.log('Comment area display:', area.style.display);
  }

  function submitTeamLeadComment() {
    console.log('submitTeamLeadComment called');
    const input = document.getElementById('teamLeadInput');
    if (!input) {
      console.log('teamLeadInput not found');
      return;
    }
    const val = input.value.trim();
    if (!val) {
      console.log('No comment text entered');
      return;
    }
    
    if (!selectedManager || !selectedEmployee) {
      console.log('No manager or employee selected');
      return;
    }
    
    const submitBtn = document.querySelector('#injectCommentArea button.btn-primary');
    setLoading(submitBtn, true, 'Adding comment...');
    fetch('/api/conversation/comment', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({manager_id: selectedManager, employee_id: selectedEmployee, text: val})})
      .then(r=>r.json())
      .then(data => { 
        console.log('Comment added successfully:', data);
        discussionHistory = data.conversation || discussionHistory; 
        input.value=''; 
        toggleInjectComment(); 
        renderDiscussion();
        // Auto-continue the discussion to get AI/enhanced response to the team lead comment
        setTimeout(() => {
          showStatus('Generating response to team lead comment...');
          continueDiscussion();
        }, 500);
      })
      .catch(error => {
        console.error('Error adding comment:', error);
      })
      .finally(()=> setLoading(submitBtn, false));
  }

  // Generation modal
  function openPromptModal(target) {
    generationTarget = target; // 'project-manager' or 'employee'
    document.getElementById('generationPrompt').value = '';
    document.getElementById('promptModalTitle').textContent = target === 'project-manager' ? 'Generate Project Manager Data' : 'Generate Employee Data';
    document.getElementById('promptModal').classList.add('show');
  }

  document.getElementById('promptForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const prompt = document.getElementById('generationPrompt').value.trim();
    const modalBtn = document.querySelector('#promptForm button.btn-primary');
    setLoading(modalBtn, true, 'Generating...');
    if (generationTarget === 'project-manager') {
      await generateManagerData(prompt);
    } else if (generationTarget === 'employee') {
      await generateEmployeeData(prompt);
    }
    setLoading(modalBtn, false);
    closeModal('promptModal');
  });

  async function generateManagerData(promptText){
  const btn = document.querySelector('#managerForm .btn-generate');
  setLoading(btn, true, 'Generating manager...');
    try {
      const res = await fetch('/api/generate/project-manager', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({prompt: promptText||''})});
      const data = await res.json();
      const pm = data.project_manager;
      document.getElementById('managerName').value = pm.name || '';
      document.getElementById('managerRole').value = pm.role || '';
      document.getElementById('managerDepartment').value = pm.department || '';
      document.getElementById('managerEmail').value = pm.email || '';
      document.getElementById('managerExperience').value = pm.experience_years || '';
      document.getElementById('managerFocus').value = pm.focus_area || '';
      document.getElementById('managerActiveProject').value = pm.active_project || '';
      document.getElementById('managerProjectSummary').value = pm.project_summary || '';
      document.getElementById('managerRequiredSkills').value = (pm.required_skills||[]).join(', ');
    } catch(err){ alert('Error generating project manager data'); }
    finally { setLoading(btn, false); }
  }

  async function generateEmployeeData(promptText){
  const btn = document.querySelector('#employeeForm .btn-generate');
  setLoading(btn, true, 'Generating employee...');
    try {
      const res = await fetch('/api/generate/employee', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({prompt: promptText||'', manager_id: selectedManager})});
      const data = await res.json();
      const emp = data.employee;
      document.getElementById('employeeName').value = emp.name || '';
      document.getElementById('employeeTitle').value = emp.title || '';
      document.getElementById('employeeExperience').value = emp.experience_years || '';
      document.getElementById('employeeEducation').value = emp.education || '';
      document.getElementById('employeeLocation').value = emp.location || '';
      document.getElementById('employeeSkills').value = (emp.skills||[]).join(', ');
      document.getElementById('employeeSummary').value = emp.summary || '';
      const m = emp.metrics || {};
      const metricsText = Object.entries(m).map(([k,v])=>`${k}: ${v}`).join(', ');
      document.getElementById('employeeMetrics').value = metricsText;
    } catch(err){ alert('Error generating employee data'); }
    finally { setLoading(btn, false); }
  }

  // Form submissions
  document.getElementById('managerForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const f = e.target;
    const payload = {
      name: f.name.value.trim(),
      role: f.role.value.trim(),
      department: f.department.value.trim(),
      email: f.email.value.trim(),
      experience: parseInt(f.experience.value,10)||0,
      focus_area: f.focus_area.value.trim(),
      active_project: f.active_project.value.trim(),
      project_summary: f.project_summary.value.trim(),
      required_skills: f.required_skills.value.split(',').map(s=>s.trim()).filter(Boolean)
    };
    const submitBtn = f.querySelector('button.btn-primary[type="submit"]');
  // Correct boolean usage (was 'True')
  setLoading(submitBtn, true, 'Saving manager...');
    try {
      const res = await fetch('/api/project-managers', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
      const data = await res.json();
      if (data.project_manager){ managerData[data.project_manager.id] = data.project_manager; prependManager(data.project_manager); }
      else alert('Error adding project manager');
    } catch(err){ alert('Network error adding project manager'); }
    finally { setLoading(submitBtn, false); }
    closeModal('addManagerModal');
  });

  document.getElementById('employeeForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const f = e.target;
    const skillsArr = f.skills.value.split(',').map(s=>s.trim()).filter(Boolean);
    // Parse metrics textarea (Key: value, Key2: value ...)
    const metrics = {};
    const rawMetrics = f.metrics.value.trim();
    if(rawMetrics){
      rawMetrics.split(',').map(p=>p.trim()).filter(Boolean).forEach(pair=>{
        const idx = pair.indexOf(':');
        if(idx>0){
          const key = pair.slice(0,idx).trim();
          const valRaw = pair.slice(idx+1).trim();
          const num = parseInt(valRaw,10);
          metrics[key] = isNaN(num) ? valRaw : num;
        }
      });
    }
    const payload = {
      name: f.name.value.trim(),
      title: f.title.value.trim(),
      experience: parseInt(f.experience.value,10)||0,
      education: f.education.value.trim(),
      location: f.location.value.trim(),
      skills: skillsArr,
      summary: f.summary.value.trim(),
      metrics: metrics
    };
    const submitBtn = f.querySelector('button.btn-primary[type="submit"]');
    setLoading(submitBtn, true, 'Saving employee...');
    try {
      const res = await fetch('/api/employees', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
      const data = await res.json();
      if (data.employee){ employeeData[data.employee.id] = data.employee; prependEmployee(data.employee); }
      else alert('Error adding employee');
    } catch(err){ alert('Network error adding employee'); }
    finally { setLoading(submitBtn, false); }
    closeModal('addEmployeeModal');
  });

  function prependManager(pm){
    const list = document.getElementById('managerList');
    const el = document.createElement('div');
    el.className='user-item';
    el.onclick = () => selectManager(pm.id, el);
    el.innerHTML = `<h4>${pm.name}</h4><p>${pm.role}</p><span class="company">${pm.department}</span>`;
    list.prepend(el);
  }

  function prependEmployee(emp){
    const list = document.getElementById('employeeList');
    const el = document.createElement('div');
    el.className='user-item';
    el.onclick = () => selectEmployee(emp.id, el);
    el.innerHTML = `<h4>${emp.name}</h4><p>${emp.title}</p><span class="experience">${emp.experience_years} yrs</span><div class="skills">${(emp.skills||[]).slice(0,3).join(', ')}</div>`;
    list.prepend(el);
  }

  function closeModal(modalId){ document.getElementById(modalId).classList.remove('show'); }
  function openAddManagerModal(){ document.getElementById('addManagerModal').classList.add('show'); }
  function openAddEmployeeModal(){ document.getElementById('addEmployeeModal').classList.add('show'); }

  // Allow clicking outside to close
  window.onclick = function(ev){ if (ev.target.classList.contains('modal')) ev.target.classList.remove('show'); };

  // Style for team lead and HR messages
  const styleTag = document.createElement('style');
  styleTag.innerHTML = `
    .message.teamlead { border-left-color:#16a085; background:#ecf9f6; }
    .message.hr { border-left-color:#3498db; background:#ebf3fd; }
    .message.manager { border-left-color:#e74c3c; background:#fdf2f2; }
  `;
  document.head.appendChild(styleTag);

  // Splitter drag logic (unchanged)
  let isDragging=false, startX=0, startWidth=0;
  document.getElementById('splitter').addEventListener('mousedown', function(e){
    isDragging=true; startX=e.clientX; const profileColumn=document.getElementById('profileColumn'); startWidth=parseInt(window.getComputedStyle(profileColumn).width,10); document.body.style.cursor='col-resize'; document.body.style.userSelect='none'; this.classList.add('dragging'); e.preventDefault();
  });
  document.addEventListener('mousemove', function(e){ if(!isDragging)return; const dx=e.clientX-startX; const newWidth=startWidth+dx; const flex=document.querySelector('.flexible-columns'); const total=flex.offsetWidth-5; if(newWidth>=250 && (total-newWidth)>=250){ const profileColumn=document.getElementById('profileColumn'); const conversationColumn=document.getElementById('conversationColumn'); profileColumn.style.flex='none'; profileColumn.style.width=newWidth+'px'; conversationColumn.style.flex='1'; conversationColumn.style.width='auto'; } });
  document.addEventListener('mouseup', function(){ if(isDragging){ isDragging=false; document.body.style.cursor=''; document.body.style.userSelect=''; document.getElementById('splitter').classList.remove('dragging'); } });
</script>
{% endblock %}
